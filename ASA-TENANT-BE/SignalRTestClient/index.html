<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SignalR LowStockAlert Tester</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .row { margin-bottom: 12px; }
      label { display: inline-block; min-width: 140px; }
      input { padding: 6px 8px; width: 360px; }
      button { padding: 8px 12px; cursor: pointer; }
      #log { margin-top: 16px; padding: 12px; border: 1px solid #ddd; background: #fafafa; height: 320px; overflow: auto; white-space: pre-wrap; }
      .ok { color: #0a7; }
      .err { color: #b00; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.5/dist/browser/signalr.min.js"></script>
  </head>
  <body>
    <h2>SignalR LowStockAlert Tester</h2>

    <div class="row">
      <label for="hubUrl">Hub URL</label>
      <input id="hubUrl" value="https://asa-tenant-be.onrender.com/notificationHub" />
    </div>
    <div class="row">
      <label for="shopId">Shop ID</label>
      <input id="shopId" placeholder="Nhập shopId để join nhóm Shop_{id}" />
    </div>
    <div class="row">
      <label for="userId">User ID</label>
      <input id="userId" placeholder="Nhập userId để join nhóm User_{id}" />
    </div>
    <div class="row">
      <button id="btnConnect">Kết nối</button>
      <button id="btnJoinShop">Join Shop Group</button>
      <button id="btnJoinUser">Join User Group</button>
      <button id="btnDisconnect">Ngắt kết nối</button>
    </div>

    <div id="status">Chưa kết nối</div>
    <div id="log"></div>

    <script>
      const logEl = document.getElementById('log');
      const statusEl = document.getElementById('status');
      const hubUrlEl = document.getElementById('hubUrl');
      const shopIdEl = document.getElementById('shopId');
      const userIdEl = document.getElementById('userId');
      const btnConnect = document.getElementById('btnConnect');
      const btnJoinShop = document.getElementById('btnJoinShop');
      const btnJoinUser = document.getElementById('btnJoinUser');
      const btnDisconnect = document.getElementById('btnDisconnect');

      let connection = null;

      function log(msg, cls) {
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        if (cls) line.className = cls;
        line.textContent = `[${time}] ${msg}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }

      async function ensureSignalR() {
        if (window.signalR) return true;
        // Fallback 1: unpkg
        try {
          await loadScript('https://unpkg.com/@microsoft/signalr@8.0.5/dist/browser/signalr.min.js');
          if (window.signalR) return true;
        } catch {}
        // Fallback 2: jsDelivr latest
        try {
          await loadScript('https://cdn.jsdelivr.net/npm/@microsoft/signalr/dist/browser/signalr.min.js');
          if (window.signalR) return true;
        } catch {}
        log('Không tải được script SignalR từ CDN. Kiểm tra kết nối mạng/CORS.', 'err');
        return false;
      }

      async function connect() {
        const ok = await ensureSignalR();
        if (!ok) { return; }
        const hubUrl = hubUrlEl.value.trim();
        if (!hubUrl) { log('Thiếu Hub URL', 'err'); return; }

        if (connection) {
          try { await connection.stop(); } catch {}
          connection = null;
        }

        connection = new signalR.HubConnectionBuilder()
          .withUrl(hubUrl, { withCredentials: true })
          .withAutomaticReconnect()
          .build();

        // Lắng nghe LowStockAlert (emit trực tiếp từ BE RealtimeNotifier)
        connection.on('LowStockAlert', (payload) => {
          log('LowStockAlert: ' + JSON.stringify(payload), 'ok');
        });

        // Phòng trường hợp BE gửi qua ReceiveNotification
        connection.on('ReceiveNotification', (packet) => {
          log('ReceiveNotification: ' + JSON.stringify(packet), 'ok');
        });
        connection.on('SubscriptionExpiryReminder', (payload) => {
          log('SubscriptionExpiryReminder: ' + JSON.stringify(payload), 'ok');
        });
        connection.on('CustomerRankUp', (payload) => {
          log('CustomerRankUp: ' + JSON.stringify(payload), 'ok');
        });
        connection.onreconnecting(() => statusEl.textContent = 'Đang reconnect...');
        connection.onreconnected(() => statusEl.textContent = 'Đã reconnect');
        connection.onclose(() => statusEl.textContent = 'Đã ngắt kết nối');

        try {
          await connection.start();
          statusEl.textContent = 'Đã kết nối';
          log('Connected to hub: ' + hubUrl, 'ok');
        } catch (err) {
          log('Connect error: ' + (err && err.message ? err.message : err), 'err');
          statusEl.textContent = 'Lỗi kết nối';
        }
      }

      async function joinShopGroup() {
        if (!connection) { log('Chưa kết nối', 'err'); return; }
        const shopId = shopIdEl.value.trim();
        if (!shopId) { log('Thiếu Shop ID', 'err'); return; }
        try {
          await connection.invoke('JoinShopGroup', Number(shopId));
          log('Joined group: Shop_' + shopId, 'ok');
        } catch (err) {
          log('Join Shop Group error: ' + (err && err.message ? err.message : err), 'err');
        }
      }

      async function joinUserGroup() {
        if (!connection) { log('Chưa kết nối', 'err'); return; }
        const userId = userIdEl.value.trim();
        if (!userId) { log('Thiếu User ID', 'err'); return; }
        try {
          await connection.invoke('JoinUserGroup', Number(userId));
          log('Joined group: User_' + userId, 'ok');
        } catch (err) {
          log('Join User Group error: ' + (err && err.message ? err.message : err), 'err');
        }
      }

      async function disconnect() {
        if (!connection) return;
        try {
          await connection.stop();
          statusEl.textContent = 'Đã ngắt kết nối';
          log('Disconnected', 'ok');
        } catch (err) {
          log('Disconnect error: ' + (err && err.message ? err.message : err), 'err');
        }
      }

      btnConnect.addEventListener('click', connect);
      btnJoinShop.addEventListener('click', joinShopGroup);
      btnJoinUser.addEventListener('click', joinUserGroup);
      btnDisconnect.addEventListener('click', disconnect);
    </script>
  </body>
  </html>


